{% extends "base.html" %}
{% block title %}{{ t('payments_title', default='Money Out') }} - FiCore{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="page-title">
        <h1>{{ t('payments_title', default='Money Out') }}</h1>
        <small class="subtext">{{ t('payments_subtitle', default='Ku…óin Da Ka Biya Wasu') }}</small>
    </div>
    <div class="mb-4">
        {% if can_interact %}
            <a href="{{ url_for('payments.add') }}" class="btn btn-secondary">{{ t('payments_add_title', default='Add Money Out') }}</a>
        {% else %}
            <a href="{{ url_for('general_bp.subscription_required') }}" class="btn btn-secondary">{{ t('payments_add_title', default='Add Money Out') }}</a>
        {% endif %}
        <a href="{{ url_for('payments.manage') }}" class="btn btn-primary">{{ t('payments_manage', default='Manage Payments') }}</a>
    </div>
    {% if payments|length > 0 %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="paymentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>{{ t('payments_party_name', default='Party Name') }}</th>
                        <th>{{ t('general_amount', default='Amount') }}</th>
                        <th>{{ t('general_date', default='Date') }}</th>
                        <th>{{ t('payments_payment_method', default='Payment Method') }}</th>
                        <th>{{ t('general_category', default='Category') }}</th>
                        <th>{{ t('general_actions', default='Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td data-label="{{ t('payments_party_name', default='Party Name') }}">{{ payment.party_name }}</td>
                            <td data-label="{{ t('general_amount', default='Amount') }}">{{ format_currency(payment.amount) }}</td>
                            <td data-label="{{ t('general_date', default='Date') }}">{{ format_date(payment.created_at) }}</td>
                            <td data-label="{{ t('payments_payment_method', default='Payment Method') }}">{{ payment.method or '-' }}</td>
                            <td data-label="{{ t('general_category', default='Category') }}">{{ payment.category or '-' }}</td>
                            <td data-label="{{ t('general_actions', default='Actions') }}">
                                <button class="btn btn-secondary btn-sm actions-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#actionsModal"
                                        data-id="{{ payment._id }}"
                                        data-name="{{ payment.party_name }}"
                                        data-amount="{{ payment.amount }}"
                                        data-date="{{ format_date(payment.created_at) }}"
                                        data-method="{{ payment.method or '' }}"
                                        data-category="{{ payment.category or '' }}"
                                        data-description="{{ payment.description or '' }}"
                                        data-contact="{{ payment.contact or '' }}">
                                    {{ t('general_actions', default='Actions') }}
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <p class="text-muted">{{ t('payments_no_records', default='No money out recorded') }}</p>
            <p class="mt-2">{{ t('payments_add_first', default='Start by logging your first money out.') }}</p>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="actionsModal" tabindex="-1" aria-labelledby="actionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionsModalLabel">{{ t('payments_payment_details', default='Payment Details') }}</h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{{ t('payments_party_name', default='Party Name') }}:</strong> <span id="modalName"></span></p>
                        <p><strong>{{ t('general_amount', default='Amount') }}:</strong> <span id="modalAmount"></span></p>
                        <p><strong>{{ t('payments_payment_method', default='Payment Method') }}:</strong> <span id="modalMethod"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{{ t('general_category', default='Category') }}:</strong> <span id="modalCategory"></span></p>
                        <p><strong>{{ t('general_date', default='Date') }}:</strong> <span id="modalDate"></span></p>
                        <p><strong>{{ t('general_description', default='Description') }}:</strong> <span id="modalDescription"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="viewBtn" class="btn btn-primary" href="#">{{ t('general_view', default='View') }}</a>
                {% if can_interact %}
                    <a id="downloadBtn" class="btn btn-primary" href="#">{{ t('payments_download_receipt', default='Download Receipt') }}</a>
                    <button id="shareBtn" class="btn btn-primary" style="display: none;">{{ t('payments_share_receipt', default='Share Receipt') }}</button>
                {% else %}
                    <a id="downloadBtn" class="btn btn-primary disabled" href="{{ url_for('general_bp.subscription_required') }}">{{ t('payments_download_receipt', default='Download Receipt') }}</a>
                    <button id="shareBtn" class="btn btn-primary disabled" style="display: none;" onclick="alert('{{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to share payments.') }}')">{{ t('payments_share_receipt', default='Share Receipt') }}</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">{{ t('payments_share_receipt', default='Share Receipt') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
            </div>
            <div class="modal-body">
                {% if not can_interact %}
                    <div class="alert alert-warning" role="alert">
                        {{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to share payments.') }}
                        <a href="{{ url_for('general_bp.subscription_required') }}" class="alert-link">{{ t('general_subscribe', default='Subscribe now') }}</a>
                    </div>
                {% endif %}
                <form id="shareForm" {% if not can_interact %}onsubmit="return false;"{% endif %}>
                    <div class="mb-3">
                        <label for="shareType" class="form-label">{{ t('payments_share_type', default='Share Type') }}</label>
                        <select class="form-select" id="shareType" required {% if not can_interact %}disabled{% endif %}>
                            <option value="sms">{{ t('general_sms', default='SMS') }}</option>
                            <option value="whatsapp">{{ t('general_whatsapp', default='WhatsApp') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">{{ t('general_message', default='Message') }}</label>
                        <textarea class="form-control" id="shareMessage" rows="4" required {% if not can_interact %}disabled{% endif %}></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="sendShareBtn" {% if not can_interact %}disabled{% endif %}>{{ t('payments_share_receipt', default='Share Receipt') }}</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_cancel', default='Cancel') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<style>
.modal-footer .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: clamp(0.875rem, 2vw, 0.9375rem);
    box-shadow: var(--card-shadow);
    transition: var(--transition-base);
}
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]) {
    background: var(--button-primary-bg);
    color: #ffffff;
    border: none;
}
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]):hover,
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]):focus {
    background: var(--button-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}
.modal-footer.two-buttons .btn:last-child {
    background: var(--button-secondary-bg);
    color: var(--button-secondary-border);
    border: 2px solid var(--button-secondary-border);
}
.modal-footer.two-buttons .btn:last-child:hover,
.modal-footer.two-buttons .btn:last-child:focus {
    background: var(--button-secondary-hover);
    color: var(--text-color);
    transform: translateY(-2px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    let currentPaymentData = null;

    function updateModalButtonClasses() {
        const modalFooter = document.querySelector('#actionsModal .modal-footer');
        const visibleButtons = Array.from(modalFooter.querySelectorAll('.btn')).filter(btn => btn.style.display !== 'none');
        
        modalFooter.classList.remove('two-buttons');
        if (visibleButtons.length === 2) {
            modalFooter.classList.add('two-buttons');
            visibleButtons.forEach((btn, index) => {
                if (index === 0 && !btn.dataset.bsDismiss) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                } else if (btn.dataset.bsDismiss) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
        } else {
            const viewBtn = document.getElementById('viewBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const shareBtn = document.getElementById('shareBtn');
            const closeBtn = modalFooter.querySelector('[data-bs-dismiss="modal"]');
            [viewBtn, downloadBtn, shareBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                }
            });
            if (closeBtn) {
                closeBtn.classList.remove('btn-primary');
                closeBtn.classList.add('btn-secondary');
            }
        }
    }

    document.querySelectorAll('.actions-btn').forEach(button => {
        button.addEventListener('click', () => {
            console.log('Actions button clicked:', button.dataset.id);
            currentPaymentData = {
                _id: button.dataset.id,
                name: button.dataset.name,
                amount: parseFloat(button.dataset.amount).toLocaleString(),
                date: button.dataset.date,
                method: button.dataset.method,
                category: button.dataset.category,
                description: button.dataset.description,
                contact: button.dataset.contact
            };

            document.getElementById('modalName').textContent = currentPaymentData.name;
            document.getElementById('modalAmount').textContent = `{{ t('general_currency_symbol', default='‚Ç¶') }}${currentPaymentData.amount}`;
            document.getElementById('modalMethod').textContent = currentPaymentData.method || '-';
            document.getElementById('modalCategory').textContent = currentPaymentData.category || '-';
            document.getElementById('modalDate').textContent = currentPaymentData.date;
            document.getElementById('modalDescription').textContent = currentPaymentData.description || '-';

            document.getElementById('viewBtn').href = `/payments/view/${currentPaymentData._id}`;
            document.getElementById('downloadBtn').href = `/payments/generate_pdf/${currentPaymentData._id}`;
            document.getElementById('shareBtn').style.display = currentPaymentData.contact ? 'inline-block' : 'none';

            updateModalButtonClasses();
        });
    });

    document.getElementById('shareBtn').addEventListener('click', () => {
        if (!currentPaymentData) {
            console.error('No payment data available');
            return;
        }
        const defaultMessage = `Payment from FiCore Records\nRecipient: ${currentPaymentData.name}\nAmount: {{ t('general_currency_symbol', default='‚Ç¶') }}${currentPaymentData.amount}\nDate: ${currentPaymentData.date}\nPayment ID: ${currentPaymentData._id}`;
        document.getElementById('shareMessage').value = defaultMessage;
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    });

    document.getElementById('sendShareBtn').addEventListener('click', function() {
        if (!currentPaymentData) {
            console.error('No payment data available');
            return;
        }
        
        const shareType = document.getElementById('shareType').value;
        const message = document.getElementById('shareMessage').value;
        
        if (!message.trim()) {
            alert('{{ t('general_message_required', default='Message is required') }}');
            return;
        }
        
        this.disabled = true;
        this.textContent = '{{ t('general_sending', default='Sending...') }}';
        
        fetch('/payments/share', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                paymentId: currentPaymentData._id,
                recipient: currentPaymentData.contact,
                message,
                type: shareType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ t('payments_share_success', default='Payment shared successfully') }}');
                bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('actionsModal')).hide();
            } else {
                alert('{{ t('payments_share_failed', default='Failed to share payment') }}: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error sharing payment:', error);
            alert('{{ t('payments_share_error', default='Error sharing payment') }}');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '{{ t('payments_share_receipt', default='Share Receipt') }}';
        });
    });
});
</script>
{% endblock %}
